<div class="chat-container">

  <!-- Header -->
  <div class="chat-header">
    <div class="header-content">
      <h1>
        <i class="bi bi-chat-dots"></i>
        Support Chat
      </h1>

      <div class="header-actions">
        <p class="status-info">
          <span class="status-badge" [ngClass]="'status-' + (chatStatus | lowercase)">
            <i class="bi" [ngClass]="getStatusIcon(chatStatus)"></i>
            {{ chatStatus | titlecase }}
          </span>
        </p>
        @if (chatStatus === 'active') {
          <button class="btn-end-chat" (click)="openEndChatConfirmation()" title="End this conversation">
            <i class="bi bi-x-circle"></i>
            End Chat
          </button>
        }
      </div>
    </div>
  </div>

  <!-- Chat Content -->
  <div class="chat-wrapper">

    <!-- Messages Area -->
    <div class="messages-area" #messagesArea>
      <div class="messages-container" #messagesContainer>

        @if (messages.length > 0) {
          @for (message of messages; track message._id ?? $index) {
            <div
              class="message-group"
              [class.message-sent]="isSentByCurrentUser(message)"
            >
              <div class="message-item">

                <!-- Avatar -->
                <div class="message-avatar">
                  @switch (message.senderType) {
                    @case ('Admin') {
                      <i class="bi bi-shield-check"></i>
                    }
                    @case ('Agent') {
                      <i class="bi bi-person-badge"></i>
                    }
                    @default {
                      <i class="bi bi-person-circle"></i>
                    }
                  }
                </div>

                <!-- Content -->
                <div class="message-content">
                  <div class="message-header">
                    <span class="sender-name">
                      {{ message.sender.firstName }}
                      {{ message.sender.lastName }}
                    </span>

                    <span
                      class="sender-type"
                      [class]="'type-' + (message.senderType | lowercase)"
                    >
                      {{ message.senderType }}
                    </span>

                    <span class="message-time">
                      {{ message.timestamp | date: 'short' }}
                    </span>
                  </div>

                  <div class="message-text">
                    {{ message.content }}
                  </div>

                  @if (!message.isRead && !isSentByCurrentUser(message)) {
                    <span class="unread-indicator">
                      <i class="bi bi-clock"></i>
                      Unread
                    </span>
                  }
                </div>

              </div>
            </div>
          }

        } @else {

          <div class="no-messages">
            <i class="bi bi-chat-left"></i>
            <p>No messages yet. Start the conversation!</p>
          </div>

        }

      </div>
    </div>

    <!-- Input Area -->
    @if (chatStatus === 'active') {
      <div class="input-area">
        <div class="input-wrapper">
          <textarea
            class="message-input"
            placeholder="Type your message here..."
            [(ngModel)]="messageText"
            (keydown.enter)="sendMessage($event)"
            [disabled]="isSending"
          ></textarea>

          <button
            class="btn-send"
            (click)="sendMessage()"
            [disabled]="!messageText.trim() || isSending"
          >
            @if (isSending) {
              <i class="bi bi-arrow-repeat"></i>
              Sending...
            } @else {
              <i class="bi bi-send"></i>
              Send
            }
          </button>
        </div>

        <div class="input-info">
          <small>Press Enter to send, Shift+Enter for new line</small>
        </div>
      </div>
    } @else {
      <div class="chat-closed">
        <div class="closed-content">
          <i class="bi bi-lock"></i>
          <p>This conversation has been <strong>{{ chatStatus | uppercase }}</strong></p>
          @if(currentUserRole === 'User'){

              <button class="btn-new-chat" (click)="startNewChat()">
                <i class="bi bi-plus-circle"></i>
                Start New Chat
              </button>
          }
        </div>
      </div>
    }

  </div>

  <!-- End Chat Confirmation Modal -->
  @if (showEndChatConfirmation) {
    <div class="modal-backdrop" (click)="closeEndChatConfirmation()"></div>
    <div class="modal-container">
      <div class="modal-content">
        <div class="modal-icon warning">
          <i class="bi bi-exclamation-triangle"></i>
        </div>
        <h2>End Conversation?</h2>
        <p>Are you sure you want to end this conversation? You won't be able to send messages after closing.</p>
        <div class="modal-actions">
          <button class="btn-cancel" (click)="closeEndChatConfirmation()">
            <i class="bi bi-x"></i>
            Cancel
          </button>
          <button class="btn-confirm" (click)="confirmEndChat()" [disabled]="isEndingChat">
            @if (isEndingChat) {
              <i class="bi bi-arrow-repeat"></i>
              Ending...
            } @else {
              <i class="bi bi-check-circle"></i>
              End Chat
            }
          </button>
        </div>
      </div>
    </div>
  }
</div>
